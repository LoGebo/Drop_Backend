<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador de Rutas de Transporte</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            box-sizing: border-box;
        }
        
        h1 {
            text-align: center;
            color: #0078d7;
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .coords-group {
            display: flex;
            gap: 10px;
        }
        
        .coords-group input {
            flex: 1;
        }
        
        button {
            background-color: #0078d7;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #0056a3;
        }
        
        .results {
            margin-top: 30px;
            display: none;
        }
        
        .segment {
            background-color: #f9f9f9;
            border-left: 4px solid #0078d7;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 5px 5px 0;
        }
        
        .segment.WALK { border-left-color: #009688; }
        .segment.BUS { border-left-color: #2196F3; }
        .segment.MINIBUS { border-left-color: #03A9F4; }
        .segment.TRAIN { border-left-color: #FF5722; }
        .segment.METRO { border-left-color: #F44336; }
        .segment.TRANSFER { border-left-color: #9E9E9E; }
        
        .segment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .segment-type {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 14px;
            color: white;
        }
        
        .segment-type.WALK { background-color: #009688; }
        .segment-type.BUS { background-color: #2196F3; }
        .segment-type.MINIBUS { background-color: #03A9F4; }
        .segment-type.TRAIN { background-color: #FF5722; }
        .segment-type.METRO { background-color: #F44336; }
        .segment-type.TRANSFER { background-color: #9E9E9E; }
        
        .segment-details {
            margin-top: 10px;
            font-size: 14px;
            color: #555;
        }
        
        .trip-summary {
            background-color: #e9f7ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .trip-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .trip-stat {
            text-align: center;
            flex: 1;
        }
        
        .trip-stat span {
            display: block;
            font-size: 24px;
            font-weight: bold;
            color: #0078d7;
        }
        
        .trip-stat label {
            font-size: 14px;
            color: #666;
        }
        
        .nearby-stops {
            margin-top: 10px;
            font-size: 14px;
        }
        
        .nearby-stop {
            margin-bottom: 5px;
        }
        
        .error-message {
            background-color: #ffebee;
            color: #d32f2f;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        
        .preference-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .preference-item {
            flex: 1;
            min-width: 200px;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            background-color: #f0f0f0;
            padding: 5px 10px;
            border-radius: 4px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }
        
        @media (max-width: 768px) {
            .coords-group {
                flex-direction: column;
            }
            
            .preference-item {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Planificador de Rutas de Transporte</h1>
        
        <div class="error-message" id="errorMessage"></div>
        
        <form id="routePlannerForm">
            <div class="form-group">
                <label for="origin">Origen</label>
                <div class="coords-group">
                    <input type="number" id="originLat" placeholder="Latitud" step="0.000001" required>
                    <input type="number" id="originLng" placeholder="Longitud" step="0.000001" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="destination">Destino</label>
                <div class="coords-group">
                    <input type="number" id="destLat" placeholder="Latitud" step="0.000001" required>
                    <input type="number" id="destLng" placeholder="Longitud" step="0.000001" required>
                </div>
            </div>
            
            <div class="form-group">
                <label>Preferencias</label>
                <div class="preference-group">
                    <div class="preference-item">
                        <label for="maxWalkingDistance">Distancia máxima a pie (metros)</label>
                        <input type="number" id="maxWalkingDistance" value="800" min="100" max="5000">
                    </div>
                    
                    <div class="preference-item">
                        <label for="maxTransfers">Número máximo de transbordos</label>
                        <input type="number" id="maxTransfers" value="2" min="0" max="5">
                    </div>
                </div>
                
                <div class="preference-group">
                    <div class="preference-item">
                        <label>Priorizar por:</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="prioritizeFastRoute" checked>
                                <label for="prioritizeFastRoute">Ruta más rápida</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="prioritizeLowCost">
                                <label for="prioritizeLowCost">Menor costo</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="prioritizeLowOccupancy">
                                <label for="prioritizeLowOccupancy">Menor ocupación</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="preference-item">
                        <label>Tipos de transporte:</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" name="transportType" value="BUS" checked>
                                <label>Autobús</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="transportType" value="METRO" checked>
                                <label>Metro</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="transportType" value="TRAIN" checked>
                                <label>Tren</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="transportType" value="WALK" checked>
                                <label>Caminar</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <button type="submit">Calcular Ruta</button>
        </form>
        
        <div class="results" id="results">
            <div class="trip-summary" id="tripSummary">
                <h2>Resumen del viaje</h2>
                <div class="trip-stats">
                    <div class="trip-stat">
                        <span id="totalTime">--</span>
                        <label>Minutos</label>
                    </div>
                    <div class="trip-stat">
                        <span id="totalDistance">--</span>
                        <label>Kilómetros</label>
                    </div>
                    <div class="trip-stat">
                        <span id="totalCost">--</span>
                        <label>Pesos</label>
                    </div>
                    <div class="trip-stat">
                        <span id="totalTransfers">--</span>
                        <label>Transbordos</label>
                    </div>
                </div>
                
                <div class="nearby-stops">
                    <h3>Paradas cercanas al origen:</h3>
                    <div id="originStops"></div>
                    
                    <h3>Paradas cercanas al destino:</h3>
                    <div id="destinationStops"></div>
                </div>
            </div>
            
            <h2>Ruta sugerida</h2>
            <div id="segments"></div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Para pruebas, llenar con valores por defecto
            document.getElementById('originLat').value = '19.432608';
            document.getElementById('originLng').value = '-99.133209';
            document.getElementById('destLat').value = '19.414562';
            document.getElementById('destLng').value = '-99.167721';
            
            const form = document.getElementById('routePlannerForm');
            const results = document.getElementById('results');
            const errorMessage = document.getElementById('errorMessage');
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Recopilar datos del formulario
                const origin = {
                    latitude: parseFloat(document.getElementById('originLat').value),
                    longitude: parseFloat(document.getElementById('originLng').value)
                };
                
                const destination = {
                    latitude: parseFloat(document.getElementById('destLat').value),
                    longitude: parseFloat(document.getElementById('destLng').value)
                };
                
                // Recopilar preferencias
                const transportTypeCheckboxes = document.querySelectorAll('input[name="transportType"]:checked');
                const transportTypes = Array.from(transportTypeCheckboxes).map(cb => cb.value);
                
                const preferences = {
                    maxWalkingDistance: parseInt(document.getElementById('maxWalkingDistance').value),
                    prioritizeFastRoute: document.getElementById('prioritizeFastRoute').checked,
                    prioritizeLowCost: document.getElementById('prioritizeLowCost').checked,
                    prioritizeLowOccupancy: document.getElementById('prioritizeLowOccupancy').checked,
                    maxTransfers: parseInt(document.getElementById('maxTransfers').value),
                    transportTypes: transportTypes
                };
                
                try {
                    // Limpiar mensajes anteriores
                    errorMessage.style.display = 'none';
                    
                    // Construir el cuerpo de la solicitud
                    const requestBody = {
                        origin,
                        destination,
                        preferences
                    };
                    
                    // Hacer la solicitud a la API
                    const response = await fetch('/api/trips/plan', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok || !data.success) {
                        throw new Error(data.message || 'Error al calcular la ruta');
                    }
                    
                    // Mostrar resultados
                    displayResults(data.trip);
                } catch (error) {
                    console.error('Error:', error);
                    errorMessage.textContent = error.message || 'Ocurrió un error inesperado';
                    errorMessage.style.display = 'block';
                    results.style.display = 'none';
                }
            });
            
            function displayResults(tripData) {
                if (!tripData || !tripData.success) {
                    errorMessage.textContent = tripData?.message || 'No se pudieron encontrar resultados';
                    errorMessage.style.display = 'block';
                    results.style.display = 'none';
                    return;
                }
                
                // Mostrar estadísticas del viaje
                document.getElementById('totalTime').textContent = tripData.route.totalTime;
                document.getElementById('totalDistance').textContent = (tripData.route.totalDistance / 1000).toFixed(1);
                document.getElementById('totalCost').textContent = tripData.route.totalCost.toFixed(2);
                document.getElementById('totalTransfers').textContent = tripData.route.transfers;
                
                // Mostrar paradas cercanas al origen
                const originStopsContainer = document.getElementById('originStops');
                originStopsContainer.innerHTML = '';
                
                tripData.origin.nearbyStops.forEach(stop => {
                    const stopElement = document.createElement('div');
                    stopElement.className = 'nearby-stop';
                    stopElement.textContent = `${stop.name} (${stop.distance}m) - Ruta: ${stop.routeName}`;
                    originStopsContainer.appendChild(stopElement);
                });
                
                // Mostrar paradas cercanas al destino
                const destinationStopsContainer = document.getElementById('destinationStops');
                destinationStopsContainer.innerHTML = '';
                
                tripData.destination.nearbyStops.forEach(stop => {
                    const stopElement = document.createElement('div');
                    stopElement.className = 'nearby-stop';
                    stopElement.textContent = `${stop.name} (${stop.distance}m) - Ruta: ${stop.routeName}`;
                    destinationStopsContainer.appendChild(stopElement);
                });
                
                // Mostrar segmentos de la ruta
                const segmentsContainer = document.getElementById('segments');
                segmentsContainer.innerHTML = '';
                
                tripData.route.segments.forEach(segment => {
                    const segmentElement = document.createElement('div');
                    segmentElement.className = `segment ${segment.type}`;
                    
                    const segmentHeader = document.createElement('div');
                    segmentHeader.className = 'segment-header';
                    
                    const segmentTitle = document.createElement('div');
                    segmentTitle.innerHTML = `<span class="segment-type ${segment.type}">${getTransportTypeName(segment.type)}</span> ${segment.from} → ${segment.to}`;
                    
                    const segmentTime = document.createElement('div');
                    segmentTime.textContent = `${segment.time} min`;
                    
                    segmentHeader.appendChild(segmentTitle);
                    segmentHeader.appendChild(segmentTime);
                    
                    const segmentDescription = document.createElement('div');
                    segmentDescription.textContent = segment.description;
                    
                    const segmentDetails = document.createElement('div');
                    segmentDetails.className = 'segment-details';
                    
                    let detailsText = `Distancia: ${(segment.distance / 1000).toFixed(2)} km`;
                    
                    if (segment.cost > 0) {
                        detailsText += ` • Costo: $${segment.cost.toFixed(2)}`;
                    }
                    
                    if (segment.routeName) {
                        detailsText += ` • Ruta: ${segment.routeName}`;
                    }
                    
                    segmentDetails.textContent = detailsText;
                    
                    segmentElement.appendChild(segmentHeader);
                    segmentElement.appendChild(segmentDescription);
                    segmentElement.appendChild(segmentDetails);
                    
                    segmentsContainer.appendChild(segmentElement);
                });
                
                // Mostrar el contenedor de resultados
                results.style.display = 'block';
            }
            
            function getTransportTypeName(type) {
                const types = {
                    'WALK': 'Caminar',
                    'BUS': 'Autobús',
                    'MINIBUS': 'Minibús',
                    'TRAIN': 'Tren',
                    'METRO': 'Metro',
                    'PREMIUM_BUS': 'Autobús Premium',
                    'TRANSFER': 'Transbordo'
                };
                
                return types[type] || type;
            }
        });
    </script>
</body>
</html> 